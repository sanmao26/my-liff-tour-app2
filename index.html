<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Flex Sender</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h1 class="text-xl font-bold mb-4 text-[#06c755]">Flex Sender (Reset)</h1>
        
        <div id="status" class="text-sm text-gray-500 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>

        <button onclick="forceReset()" class="text-xs text-red-500 underline mb-4">
            ‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á Error
        </button>

        <textarea id="jsonInput" class="w-full border p-2 rounded text-xs h-32 mb-4 hidden" placeholder="JSON Code"></textarea>
        
        <button id="btnSend" onclick="sendFlex()" class="hidden w-full bg-[#06c755] text-white py-3 rounded font-bold">
            ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </button>
        
        <button id="btnLogin" onclick="liff.login()" class="hidden w-full bg-[#00c300] text-white py-3 rounded font-bold">
            Login with LINE
        </button>
    </div>

    <script>
        // ‚úÖ ‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const LIFF_ID = "2008776742-meCAFErj";

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });

                // ‡∏ñ‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß
                if (liff.isLoggedIn()) {
                    document.getElementById('status').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!";
                    document.getElementById('jsonInput').classList.remove('hidden');
                    document.getElementById('btnSend').classList.remove('hidden');
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    loadSample();
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login
                    document.getElementById('status').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                    document.getElementById('btnLogin').classList.remove('hidden');
                }
            } catch (err) {
                // üö® ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ Error Permission ‡∏´‡∏£‡∏∑‡∏≠ Token ‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                document.getElementById('status').innerText = "‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: " + err.code;
                if (err.code === "FBD33" || err.message.includes("permission") || err.message.includes("revoked")) {
                    alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î OK");
                    localStorage.clear();
                    window.location.reload();
                } else {
                    alert("Error: " + err.message + "\n\n(‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á Error' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)");
                }
            }
        }

        async function sendFlex() {
            try {
                const json = JSON.parse(document.getElementById('jsonInput').value);
                const msg = (json.type === 'flex') ? json : { type: "flex", altText: "Flex", contents: json };

                if (!liff.isApiAvailable('shareTargetPicker')) {
                    alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                    return;
                }

                const res = await liff.shareTargetPicker([msg]);
                if (res) liff.closeWindow();
            } catch (e) {
                alert("JSON ‡∏ú‡∏¥‡∏î: " + e.message);
            }
        }

        function loadSample() {
            const sample = { type: "bubble", body: { type: "box", layout: "vertical", contents: [{ type: "text", text: "‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!", size: "xl", weight: "bold", align: "center", color: "#06c755" }] } };
            document.getElementById('jsonInput').value = JSON.stringify(sample);
        }

        function forceReset() {
            localStorage.clear();
            liff.logout();
            window.location.reload();
        }

        main();
    </script>
</body>
</html>
